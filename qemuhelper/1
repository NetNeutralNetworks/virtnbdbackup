import nbdhelper
import extenthandler
import sparsestream
import qemuhelper
import sys


def main():
    nbdClient = nbdhelper.nbdClient('sda')
    connection = nbdClient.connect()
    extentHandler = extenthandler.ExtentHandler(connection)
    print(extentHandler.queryBlockStatus())

    extentHandler = extenthandler.ExtentHandler(qemuhelper.qemuHelper('sda'))
    print(extentHandler.queryBlockStatus())


if __name__ == "__main__":
    main()

sys.exit(1)

writer = open('backup.data','wb')
metadata = sparsestream.SparseStream().dump_metadata("0", "", "none", "vda", False)
sparsestream.SparseStream().write_frame(writer, sparsestream.SparseStreamTypes().META, 0, len(metadata))
writer.write(metadata)
writer.write(sparsestream.SparseStreamTypes().TERM)
print("got %s extents" % len(extents))

for save in extents:
    if save.data == True:
        print("read %s from %s" %(save.length, save.offset))
        sparsestream.SparseStream().write_frame(writer, sparsestream.SparseStreamTypes().DATA, save.offset, save.length)
        if save.length >= nbdClient.maxRequestSize:
            print("bigger")
            assert save.length % 65536 == 0
            bs = 65536
            offset = save.offset
            count = int(save.length/bs)
            ct = 1
            while ct <= count:
                data = connection.pread(bs, offset)
                ct+=1
                writer.write(data)
                offset+=bs
        else:
            data = connection.pread(save.length, save.offset)
            writer.write(data)
        writer.write(sparsestream.SparseStreamTypes().TERM)
    else:
        print("skip %s from %s" %(save.length, save.offset))
        sparsestream.SparseStream().write_frame(writer, sparsestream.SparseStreamTypes().ZERO, save.offset, save.length)

sparsestream.SparseStream().write_frame(writer, sparsestream.SparseStreamTypes().STOP, 0, 0)
writer.close()
